<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="metrics-graphics-2.11.0/dist/metricsgraphics.min.js"></script>
    <script src="bower_components/vis/dist/vis.min.js"></script>
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" type="text/css" rel="stylesheet"/>
    <link href="metrics-graphics-2.11.0/dist/metricsgraphics.css" type="text/css" rel="stylesheet"/>
    <link href="bower_components/vis/dist/vis.min.css" type="text/css" rel="stylesheet"/>
</head>
<body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Sysdig test analysis</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li><a href="#cpu_tab">CPU</a></li>
            <li><a href="#memory_tab">Memory</a></li>
            <li><a href="#proc_tab">Processes</a></li>
            <li><a href="#io_tab">IO</a></li>

          </ul>

        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>

    <div class="row" id="cpu_tab">
        <div class="panel panel-primary">
            <div class="panel-heading">CPU</div>
            <div class="panel-body">
                <div class="col-md-6">
                    <div class="row">
                        <div id="mychart_cpu0"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-2">
                        <span>Details </span>
                        </div>
                        <div class="col-md-4">
                            <form class="form form-inline">
                                <div class="form-group">
                                    <select class="form-control" id="cpu_proc">
                                    </select>
                                    <button type="button" class="btn btn-primary" id="cpu_proc_show">show</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="row">
                        <div id="mychart_cpu_details"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="row" id="memory_tab">
        <div class="panel panel-primary">
            <div class="panel-heading">Memory</div>
            <div class="panel-body">
                    <div class="row">
                        <div id="mychart_mem"></div>
                    </div>
            </div>
        </div>
    </div>

    <div class="row" id="proc_tab">
        <div class="panel panel-primary">
            <div class="panel-heading">Processes</div>
            <div class="panel-body">
                    <div id="procs_relationship">
                    </div>
                    <table class="table table-condensed table-striped table-bordered">
                        <thead>
                            <th>Process id</th><th>Exe</th><th>Args</th>
                        </thead>
                        <tbody id="proc_info">
                        </tbody>
                    </table>
            </div>
        </div>
    </div>

    <div class="row" id="io_tab">
        <div class="panel panel-primary">
            <div class="panel-heading">IO</div>
            <div class="panel-body">
                <table id="io" class="table table-condensed table-striped table-bordered">
                    <thead>
                        <th>Process id</th><th>File name</th><th>Bytes in</th><th>Bytes out</th>
                    </thead>
                    <tbody id="io_all_list">
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <script>

    var nb_cpus = 3;
    var proc_list = {};


    function get_memory_data(data){
        var container_memory = data.containers.competent_thompson.memory;
        memory_processes = [];
        memory_data = [];
        procs = {}
        for(var key in container_memory){
            var procdata = [];
            for(var i=0;i<container_memory[key].length;i++){
                procs[key] = container_memory[key][i]['proc_name']
                    procdata.push({
                        "date": new Date((container_memory[key][i]['ts'] / 1000000)),
                        "value": container_memory[key][i]['value'][0] * 1000
                    });
            }
            memory_data.push(procdata);
        }
        for(var procid in procs){
            memory_processes.push(procs[procid]);
        }
        return {'data': memory_data, 'procs': memory_processes}
    }

    function get_per_cpu(data, proc_id){
        var cpu_data = [];
        var procs = [];
        var groups = [];
        var cpu_list = [];
        for(var i=0;i<data[proc_id].length;i++){
            procs.push(proc_id);
            if(cpu_list.indexOf(data[proc_id][i]['cpu'])==-1) {
                groups.push({'id': data[proc_id][i]['cpu'], "content": "cpu" + data[proc_id][i]['cpu']})
                cpu_list.push(data[proc_id][i]['cpu']);
            }
            metric = {'x': new Date((data[proc_id][i]['ts']*1000)), 'y': data[proc_id][i]['duration'] * 100 / (1000000000), 'group': data[proc_id][i]['cpu']}
            cpu_data.push(metric);

        }
        return {'data': cpu_data, 'groups': groups, 'procs': procs};
    }


    function get_cpu_all(data){
        var cpu_data = [];
        var procs = [];
        var groups = [];
        for(var key in data){
            procs.push(key);

            groups.push({'id': key, "content": proc_list[key]+"("+key+")"})
            for(var i=0;i<data[key].length;i++){
                metric = {'x': new Date((data[key][i]['ts']*1000)), 'y': data[key][i]['duration'] * 100 / (1000000000), 'group': key}
                cpu_data.push(metric);
            }
        }
        return {'data': cpu_data, 'groups': groups, 'procs': procs};
    }

    function get_mem(data){
        var mem_data = [];
        var procs = [];
        var groups = [];
        for(var key in data){
            procs.push(key);
            groups.push({'id': key, "content": proc_list[key]+"("+key+")"})
            for(var i=0;i<data[key].length;i++){
                metric = {'x': new Date((data[key][i]['ts']*1000)), 'y': data[key][i]['vm_size']/1000, 'group': key}
                mem_data.push(metric);
            }
        }
        return {'data': mem_data, 'groups': groups, 'procs': procs};
    }

    function get_procs(data){
        var proc_selection = "";
        var proc_info = "";
        var result = {'nodes': [], 'edges': []}
        for(var i=0;i<data.length;i++){
            var dataelt = data[i];
            proc_list[dataelt['id']] = dataelt['name'];
            proc_selection += "<option value=\"" + dataelt['id'] + "\">" + dataelt['name'] + "("+dataelt['id']+")" + "</option>";
            proc_info += "<tr><td>" + dataelt['id']+ "</td><td>" + dataelt['exe'] + "</td><td>" + dataelt['args'] + "</td></tr>";
            result['nodes'].push({'id': dataelt['id'], 'label': dataelt['name']+"("+dataelt['id']+")"});
            if(dataelt['parent']){
                result['edges'].push({'from': dataelt['parent'], 'to': dataelt['id'], arrows:'to'})
            }
        }
        $("#cpu_proc").append(proc_selection);
        $("#proc_info").append(proc_info);
        return result;
    }

    function load_io(container){
        d3.json('/container/'+container+'/io', function(data) {
            var io_list = "";
            for(var key in data){
                for(var i=0;i<data[key].length;i++){
                    var elt = data[key][i];
                    io_list += "<tr><td>" + proc_list[elt["proc_id"]] + "(" + elt["proc_id"] +")" + "</td><td>" + elt['file_name'] + "</td><td>" + elt['io_in'] + "</td><td>" + elt['io_out'] + "</td></tr>";
                }
            }
            $("#io_all_list").append(io_list);

        });
    }


    function load_per_cpu(container, proc_id){
        d3.json('/container/'+container+'/cpu/' + proc_id, function(data) {
            $("#mychart_cpu_details").html("");
            //cpu0 = get_cpu_data(data, '0');
            cpu_data = get_per_cpu(data, proc_id);
            // console.log(cpu0);

            var container = document.getElementById('mychart_cpu_details');
            var dataset = new vis.DataSet(cpu_data.data);
            var options = {
                style: 'bar',
                stack: true,
                drawPoints: false,
                legend: true,
                //width: '800px',
            };
            var graph2d = new vis.Graph2d(container, dataset, cpu_data.groups, options);
        });
    }


    function load_cpu(container){
        d3.json('/container/'+container+'/cpu', function(data) {
            //cpu0 = get_cpu_data(data, '0');
            cpu0 = get_cpu_all(data);

            var container = document.getElementById('mychart_cpu0');
            var dataset = new vis.DataSet(cpu0.data);
            var options = {
                style: 'bar',
                stack: true,
                drawPoints: false,
                legend: true,
                //width: '800px',
            };
            var graph2d = new vis.Graph2d(container, dataset, cpu0.groups, options);
        });
    }

    function load_mem(container){
        d3.json('/container/'+container+'/mem', function(data) {
            //cpu0 = get_cpu_data(data, '0');
            var mem = get_mem(data);

            var container = document.getElementById('mychart_mem');
            var dataset = new vis.DataSet(mem.data);
            var options = {
                style: 'bar',
                stack: true,
                drawPoints: false,
                legend: true,
                //width: '800px',
                dataAxis: {
                    left: {
                        title: {text: 'Mb'}
                    }

                }
            };
            var graph2d = new vis.Graph2d(container, dataset, mem.groups, options);

        });
    }

    function load_proc(container_id){
        d3.json('/container/'+container_id+'/proc', function(data) {
            var procs = get_procs(data['data']);
            var container = document.getElementById('procs_relationship');
            var nodes = new vis.DataSet(procs.nodes);
            var edges = new vis.DataSet(procs.edges);
            var netdata = {
              nodes: nodes,
              edges: edges
            };
            var options = {
                'height': '400px'
            };
            var network = new vis.Network(container, netdata, options);

            load_io(container_id);
            load_cpu(container_id);
            load_mem(container_id);

        });
    }

    $("#cpu_proc_show").click(function(){
        load_per_cpu($.urlParam('container'), $("#cpu_proc").val());
    });



    $.urlParam = function (name) {
    var results = new RegExp('[\?&]' + name + '=([^&#]*)')
                      .exec(window.location.href);

    return results[1] || 0;
}

    $(document).ready(function(){
        load_proc($.urlParam('container'));
    });

    </script>
</body>
</html>
